{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<style>
/* Form-specific enhancements */
.form-section {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-gray-200);
    margin-bottom: var(--spacing-6);
    overflow: hidden;
}

.form-section-header {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: var(--color-white);
    padding: var(--spacing-4) var(--spacing-6);
    font-weight: var(--font-weight-semibold);
    font-size: var(--font-size-lg);
    border-bottom: none;
}

.form-section-content {
    padding: var(--spacing-6);
}

.field-wrapper {
    margin-bottom: var(--spacing-5);
    position: relative;
}

.field-wrapper:last-child {
    margin-bottom: 0;
}

.field-label {
    display: block;
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-700);
    margin-bottom: var(--spacing-2);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.field-input {
    width: 100%;
    padding: var(--spacing-3) var(--spacing-4);
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    font-family: var(--font-family);
    background-color: var(--color-white);
    color: var(--color-gray-800);
    transition: var(--transition-fast);
    min-height: 44px;
    box-sizing: border-box;
}

.field-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
    background-color: var(--color-gray-50);
}

.field-help {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
    margin-top: var(--spacing-1);
    font-style: italic;
}

.field-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: var(--spacing-2) var(--spacing-3);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    margin-top: var(--spacing-2);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.field-error::before {
    content: "‚ö†Ô∏è";
    font-size: var(--font-size-sm);
}

.required-field .field-label::after {
    content: " *";
    color: var(--color-primary);
    font-weight: var(--font-weight-bold);
}

.submit-section {
    background: var(--color-gray-50);
    padding: var(--spacing-6);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    gap: var(--spacing-4);
    justify-content: flex-end;
    flex-wrap: wrap;
}

.btn-submit {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    color: var(--color-white);
    border: none;
    padding: var(--spacing-3) var(--spacing-8);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
}

.btn-submit:hover {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--color-gray-600);
    color: var(--color-white);
    border: none;
    padding: var(--spacing-3) var(--spacing-6);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
    min-height: 44px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
}

.btn-secondary:hover {
    background: var(--color-gray-700);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
    color: var(--color-white);
    text-decoration: none;
}

.btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
    color: var(--color-white);
}

.btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
}

.image-preview {
    max-width: 200px;
    max-height: 150px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 2px solid var(--color-gray-200);
    margin-top: var(--spacing-3);
}

.file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

.file-input-label {
    background: var(--color-gray-100);
    border: 2px dashed var(--color-gray-300);
    border-radius: var(--radius-md);
    padding: var(--spacing-6);
    text-align: center;
    cursor: pointer;
    transition: var(--transition-fast);
    display: block;
    color: var(--color-gray-600);
}

.file-input-label:hover {
    background: var(--color-gray-50);
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.file-input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    margin-top: var(--spacing-2);
}

.checkbox-input {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-sm);
    position: relative;
    cursor: pointer;
}

.checkbox-input:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.checkbox-input:checked::after {
    content: "‚úì";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-bold);
}

.select-wrapper {
    position: relative;
}

.select-input {
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23374151" stroke-width="2"><polyline points="6,9 12,15 18,9"></polyline></svg>');
    background-repeat: no-repeat;
    background-position: right var(--spacing-3) center;
    background-size: 16px;
    padding-right: var(--spacing-10);
}

@media (max-width: 768px) {
    .form-section-content {
        padding: var(--spacing-4);
    }
    
    .submit-section {
        padding: var(--spacing-4);
        flex-direction: column;
    }
    
    .btn-submit,
    .btn-secondary {
        width: 100%;
        justify-content: center;
    }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mejorar la experiencia de formularios
    enhanceFormFields();
    addFormValidation();
    
    function enhanceFormFields() {
        // Agregar clases personalizadas a todos los campos
        const formRows = document.querySelectorAll('.form-row');
        formRows.forEach(row => {
            const label = row.querySelector('label');
            const input = row.querySelector('input, select, textarea');
            const help = row.querySelector('.help');
            const errors = row.querySelector('.errorlist');
            
            if (label && input) {
                // Crear wrapper personalizado
                const wrapper = document.createElement('div');
                wrapper.className = 'field-wrapper';
                
                // Determinar si el campo es requerido
                if (input.required || label.textContent.includes('*')) {
                    wrapper.classList.add('required-field');
                }
                
                // Aplicar clases personalizadas
                label.className = 'field-label';
                
                if (input.type === 'file') {
                    createFileInput(input, wrapper);
                } else if (input.type === 'checkbox') {
                    createCheckboxInput(input, wrapper, label);
                } else {
                    input.className = input.tagName.toLowerCase() === 'select' 
                        ? 'field-input select-input' 
                        : 'field-input';
                    
                    if (input.tagName.toLowerCase() === 'select') {
                        const selectWrapper = document.createElement('div');
                        selectWrapper.className = 'select-wrapper';
                        input.parentNode.insertBefore(selectWrapper, input);
                        selectWrapper.appendChild(input);
                    }
                }
                
                // Agregar texto de ayuda
                if (help) {
                    help.className = 'field-help';
                }
                
                // Agregar errores
                if (errors) {
                    errors.className = 'field-error';
                }
            }
        });
    }
    
    function createFileInput(input, wrapper) {
        const fileWrapper = document.createElement('div');
        fileWrapper.className = 'file-input-wrapper';
        
        const label = document.createElement('label');
        label.className = 'file-input-label';
        label.innerHTML = 'üìÅ Seleccionar archivo<br><small>Haz clic o arrastra aqu√≠</small>';
        
        input.className = 'file-input';
        
        fileWrapper.appendChild(label);
        fileWrapper.appendChild(input);
        
        // Manejar cambio de archivo
        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                label.innerHTML = `üìÑ ${this.files[0].name}<br><small>Archivo seleccionado</small>`;
                label.style.borderColor = 'var(--color-primary)';
                label.style.color = 'var(--color-primary)';
            }
        });
    }
    
    function createCheckboxInput(input, wrapper, label) {
        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'checkbox-wrapper';
        
        input.className = 'checkbox-input';
        
        checkboxWrapper.appendChild(input);
        checkboxWrapper.appendChild(label);
    }
    
    function addFormValidation() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const requiredFields = form.querySelectorAll('[required]');
                let hasErrors = false;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.style.borderColor = '#dc2626';
                        hasErrors = true;
                    } else {
                        field.style.borderColor = 'var(--color-gray-300)';
                    }
                });
                
                if (hasErrors) {
                    e.preventDefault();
                    showNotification('Por favor, completa todos los campos requeridos', 'error');
                }
            });
        }
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#dc2626' : '#10b981'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 4000);
    }
});
</script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">üè† Inicio</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {% if add %}Agregar {{ opts.verbose_name }}{% else %}Cambiar {{ opts.verbose_name }}{% endif %}
</div>
{% endblock %}

{% block content_title %}
<div class="form-section-header">
    {% if add %}
        ‚ûï Agregar {{ opts.verbose_name }}
    {% else %}
        ‚úèÔ∏è Modificar {{ opts.verbose_name }}
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    <div class="form-section">
        <div class="form-section-content">
            {% block form_top %}{% endblock %}
            
            <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="{{ form_url }}" method="post" id="{{ opts.model_name }}_form" novalidate>
                {% csrf_token %}
                {% block form_errors %}
                    {% if errors %}
                        <div class="field-error" style="margin-bottom: var(--spacing-6);">
                            <strong>Por favor, corrige los siguientes errores:</strong>
                            {{ errors }}
                        </div>
                    {% endif %}
                {% endblock %}
                
                {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
                {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
                
                {% block field_sets %}
                    {% for fieldset in adminform %}
                        {% include "admin/includes/fieldset.html" %}
                    {% endfor %}
                {% endblock %}
                
                {% block after_field_sets %}{% endblock %}
                
                {% block inline_field_sets %}
                    {% for inline_admin_formset in inline_admin_formsets %}
                        {% include inline_admin_formset.opts.template %}
                    {% endfor %}
                {% endblock %}
                
                {% block after_related_objects %}{% endblock %}
                
                <div class="submit-section">
                    {% block submit_buttons_bottom %}
                        <div class="submit-row">
                            {% if show_save %}
                                <input type="submit" value="üíæ {% if add %}Agregar{% else %}Guardar{% endif %} {{ opts.verbose_name }}" class="btn-submit" name="_save">
                            {% endif %}
                            {% if show_save_and_add_another %}
                                <input type="submit" value="üíæ‚ûï Guardar y agregar otro" class="btn-secondary" name="_addanother">
                            {% endif %}
                            {% if show_save_and_continue %}
                                <input type="submit" value="üíæ‚úèÔ∏è Guardar y continuar editando" class="btn-secondary" name="_continue">
                            {% endif %}
                            {% if show_delete_link %}
                                <a href="{% url opts|admin_urlname:'delete' original.pk|admin_urlquote %}" class="btn-danger">
                                    üóëÔ∏è Eliminar
                                </a>
                            {% endif %}
                            <a href="{% url opts|admin_urlname:'changelist' %}" class="btn-secondary">
                                üìã Ver lista
                            </a>
                        </div>
                    {% endblock %}
                </div>
            </form>
        </div>
    </div>
</div>

{% block admin_change_form_document_ready %}
    <script>
    (function($) {
        $(document).ready(function() {
            console.log('‚úÖ Formulario de {{ opts.verbose_name }} cargado con dise√±o corporativo');
            
            // Agregar efectos visuales sutiles
            $('.field-input').on('focus', function() {
                $(this).closest('.field-wrapper').addClass('focused');
            }).on('blur', function() {
                $(this).closest('.field-wrapper').removeClass('focused');
            });
            
            // Validaci√≥n en tiempo real
            $('.field-input[required]').on('blur', function() {
                if (!$(this).val().trim()) {
                    $(this).css('border-color', '#dc2626');
                } else {
                    $(this).css('border-color', 'var(--color-primary)');
                }
            });
        });
    })(django.jQuery);
    </script>
{% endblock %}
{% endblock %}